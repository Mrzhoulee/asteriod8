<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asteroid Teams Media Studio</title>
  <style>
    body { background-color: antiquewhite; font-family: "Montserrat", sans-serif; margin: 0; padding: 20px; text-align: center; }
    .upload-btn { width: 130px; height: 45px; background-color: coral; color: black; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; margin: 10px; }
    
    /* CAMPAIGN UI - Visible by default if ref is in URL */
    #campaignContainer { display: none; margin-bottom: 30px; }
    .tutorial-box { background: white; border: 3px solid #00ff88; padding: 20px; border-radius: 15px; max-width: 600px; margin: 0 auto 20px auto; text-align: left; }
    .progress-box { background: #fff3e0; border: 2px solid coral; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; }
    
    /* Progress Bar */
    .bar-bg { height: 20px; width: 100%; background: #ddd; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #bbb; }
    #progressBarStatus { height: 100%; width: 0%; background: linear-gradient(90deg, #ff7f50, #ff4500); transition: width 0.5s ease; }
    
    .alertBox { background-color: lightcoral; padding: 15px; visibility: hidden; border-radius: 10px; margin: 10px auto; width: 80%; }
    input { margin: 8px; padding: 12px; width: 80%; max-width: 400px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>

  <div style="margin-bottom: 20px;">
    <button id="google-sign-in" style="padding: 10px 20px; cursor: pointer; border-radius: 5px; border: 1px solid black; background: white;">
        <i class="fa-brands fa-google"></i> <span id="gcm">Sign In with Google</span>
    </button>
  </div>

  <div id="campaignContainer">
    <div class="tutorial-box">
      <h2 style="color: #008044; margin-top: 0;">ðŸŒŸ 3-Month Feature Challenge</h2>
      <p>1. <b>Sign In</b> above to start tracking.<br>
      2. <b>Share</b> your link with 3 artist friends.<br>
      3. Once 3 people sign in via your link, you get featured for <b>3 Months!</b></p>
    </div>

    <div class="progress-box">
      <h3 style="margin: 0; color: coral;">Invite Progress</h3>
      <p id="countText" style="font-weight: bold;">0 / 3 Friends Joined</p>
      <div class="bar-bg"><div id="progressBarStatus"></div></div>
      
      <p style="font-size: 0.9em;">Your Referral Link:</p>
      <input type="text" id="shareLinkInput" readonly placeholder="Sign in to get your link...">
      <button id="copyBtn" class="upload-btn" style="width: 80px; height: 35px; font-size: 12px;">COPY</button>
    </div>
  </div>

  <hr style="width: 80%; margin: 30px auto; border: 0.5px solid #ccc;">

  <form id="uploadForm">
    <h2>Upload Your Media</h2>
    <input type="text" id="title" placeholder="Song Title" required><br>
    <input type="text" id="artist" placeholder="Artist Name" required><br>
    <input type="text" id="album" placeholder="Album Name" required><br>
    <input type="file" id="fileInp" accept="audio/mpeg" required><br>
    
    <div style="margin: 15px;">
        <input type="checkbox" id="agreement" style="width: auto;"> 
        <label for="agreement">I own the rights to this music.</label>
    </div>
    
    <button id="btn" class="upload-btn">UPLOAD NOW</button>
  </form>

  <div id="alertBox" class="alertBox"><h2>Uploading... please wait.</h2></div>
  <div id="ooaa" class="alertBox" style="background-color: lightgreen; color: black;"><h2>âœ… Success! Upload Complete.</h2></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref as ref2, update, get, onValue, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getStorage, getDownloadURL, uploadBytes, ref } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAvcxcXXNezL5Jip4A9WMkv_r5fpmsDoY",
    authDomain: "asteroid-cdc13.firebaseapp.com",
    databaseURL: "https://asteroid-cdc13-default-rtdb.firebaseio.com",
    projectId: "asteroid-cdc13",
    storageBucket: "asteroid-cdc13.appspot.com",
    messagingSenderId: "793353824502",
    appId: "1:793353824502:web:3ac24821911d14773ba4d7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const provider = new GoogleAuthProvider();

  const VALID_CODE = "ARTISTSOFFEB26";

  // --- 1. PAGE SETUP ---
  function init() {
    const params = new URLSearchParams(window.location.search);
    const refParam = params.get('ref');
    const inviterParam = params.get('by');

    // Show campaign if code is in URL or saved in browser
    if (refParam === VALID_CODE || localStorage.getItem('ref_active') === "true") {
      localStorage.setItem('ref_active', "true");
      document.getElementById('campaignContainer').style.display = 'block';
    }

    // Capture who referred this new person
    if (inviterParam) {
      localStorage.setItem('pending_inviter', inviterParam);
    }

    // Auto-load session
    const savedName = localStorage.getItem("fullName");
    if (savedName) {
        document.getElementById("gcm").innerHTML = savedName;
        updateUIForUser(savedName);
    }
  }

  // --- 2. GOOGLE SIGN IN ---
  document.getElementById("google-sign-in").onclick = () => {
    signInWithPopup(auth, provider).then(async (res) => {
      const user = res.user;
      const safeEmail = user.email.replace(/\./g, ',');
      const inviter = localStorage.getItem('pending_inviter');

      localStorage.setItem("email", user.email);
      localStorage.setItem("fullName", user.displayName);
      document.getElementById("gcm").innerHTML = user.displayName;

      // Check if user is new to credit the inviter
      const userRef = ref2(db, 'users/' + safeEmail);
      const snap = await get(userRef);

      if (!snap.exists() && inviter) {
        const inviterRef = ref2(db, 'referralCounts/' + inviter);
        await update(inviterRef, { count: increment(1) });
        localStorage.removeItem('pending_inviter');
      }

      await update(userRef, { email: user.email, name: user.displayName });
      updateUIForUser(user.displayName);
    });
  };

  // --- 3. REFRESH LINK & PROGRESS ---
  function updateUIForUser(name) {
    const cleanName = name.replace(/\s+/g, '_');
    const link = window.location.origin + window.location.pathname + `?ref=${VALID_CODE}&by=${cleanName}`;
    document.getElementById('shareLinkInput').value = link;

    // Listen for progress
    onValue(ref2(db, 'referralCounts/' + cleanName), (snap) => {
      const count = snap.val()?.count || 0;
      document.getElementById('countText').innerText = `${count} / 3 Friends Joined`;
      document.getElementById('progressBarStatus').style.width = Math.min((count / 3) * 100, 100) + "%";
    });
  }

  // --- 4. UPLOAD LOGIC ---
  document.getElementById("btn").onclick = async () => {
    const email = localStorage.getItem("email");
    const file = document.getElementById("fileInp").files[0];
    const title = document.getElementById("title").value;
    const artist = document.getElementById("artist").value;
    const album = document.getElementById("album").value;

    if (!email) return alert("Sign in first!");
    if (!file || !title) return alert("Missing info!");
    if (!document.getElementById("agreement").checked) return alert("Accept agreement!");

    document.getElementById("alertBox").style.visibility = "visible";

    try {
      const path = `${album}/${title}/${artist}/${file.name}`;
      const snap = await uploadBytes(ref(storage, path), file);
      const url = await getDownloadURL(snap.ref);

      const songData = {
        [title]: { [album]: { [artist]: {
          fileInp: url,
          uploader: email,
          campaign: localStorage.getItem('ref_active') ? VALID_CODE : "organic"
        }}}
      };

      await update(ref2(db, "SONGS"), songData);
      document.getElementById("alertBox").style.visibility = "hidden";
      document.getElementById("ooaa").style.visibility = "visible";
    } catch (err) {
      alert("Error uploading. Check internet.");
      document.getElementById("alertBox").style.visibility = "hidden";
    }
  };

  document.getElementById("copyBtn").onclick = () => {
    const copyText = document.getElementById("shareLinkInput");
    copyText.select();
    navigator.clipboard.writeText(copyText.value);
    alert("Link Copied! Share with 3 people.");
  };

  init();
</script>
</body>
</html>
